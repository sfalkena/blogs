<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Reproduction of paper | Sieger Falkena</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Reproduction of paper" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="lkasjdflkajsdflkajsdflkjasdf" />
<meta property="og:description" content="lkasjdflkajsdflkajsdflkjasdf" />
<link rel="canonical" href="https://sfalkena.github.io/ESPCN_reproduction/fastpages/jupyter/2020/04/20/ESPCN_reproduction.html" />
<meta property="og:url" content="https://sfalkena.github.io/ESPCN_reproduction/fastpages/jupyter/2020/04/20/ESPCN_reproduction.html" />
<meta property="og:site_name" content="Sieger Falkena" />
<meta property="og:image" content="https://sfalkena.github.io/ESPCN_reproduction/images/some_folder/your_image.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-20T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"lkasjdflkajsdflkajsdflkjasdf","@type":"BlogPosting","headline":"Reproduction of paper","dateModified":"2020-04-20T00:00:00-05:00","datePublished":"2020-04-20T00:00:00-05:00","image":"https://sfalkena.github.io/ESPCN_reproduction/images/some_folder/your_image.png","url":"https://sfalkena.github.io/ESPCN_reproduction/fastpages/jupyter/2020/04/20/ESPCN_reproduction.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://sfalkena.github.io/ESPCN_reproduction/fastpages/jupyter/2020/04/20/ESPCN_reproduction.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/ESPCN_reproduction/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://sfalkena.github.io/ESPCN_reproduction/feed.xml" title="Sieger Falkena" /><link rel="shortcut icon" type="image/x-icon" href="/ESPCN_reproduction/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Reproduction of paper | Sieger Falkena</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Reproduction of paper" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="lkasjdflkajsdflkajsdflkjasdf" />
<meta property="og:description" content="lkasjdflkajsdflkajsdflkjasdf" />
<link rel="canonical" href="https://sfalkena.github.io/ESPCN_reproduction/fastpages/jupyter/2020/04/20/ESPCN_reproduction.html" />
<meta property="og:url" content="https://sfalkena.github.io/ESPCN_reproduction/fastpages/jupyter/2020/04/20/ESPCN_reproduction.html" />
<meta property="og:site_name" content="Sieger Falkena" />
<meta property="og:image" content="https://sfalkena.github.io/ESPCN_reproduction/images/some_folder/your_image.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-20T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"lkasjdflkajsdflkajsdflkjasdf","@type":"BlogPosting","headline":"Reproduction of paper","dateModified":"2020-04-20T00:00:00-05:00","datePublished":"2020-04-20T00:00:00-05:00","image":"https://sfalkena.github.io/ESPCN_reproduction/images/some_folder/your_image.png","url":"https://sfalkena.github.io/ESPCN_reproduction/fastpages/jupyter/2020/04/20/ESPCN_reproduction.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://sfalkena.github.io/ESPCN_reproduction/fastpages/jupyter/2020/04/20/ESPCN_reproduction.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://sfalkena.github.io/ESPCN_reproduction/feed.xml" title="Sieger Falkena" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/ESPCN_reproduction/">Sieger Falkena</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/ESPCN_reproduction/about/">About Me</a><a class="page-link" href="/ESPCN_reproduction/search/">Search</a><a class="page-link" href="/ESPCN_reproduction/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Reproduction of paper</h1><p class="page-description">lkasjdflkajsdflkajsdflkjasdf</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-04-20T00:00:00-05:00" itemprop="datePublished">
        Apr 20, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      9 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/ESPCN_reproduction/categories/#fastpages">fastpages</a>
        &nbsp;
      
        <a class="category-tags-link" href="/ESPCN_reproduction/categories/#jupyter">jupyter</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/sfalkena/ESPCN_reproduction/tree/master/_notebooks/2020-04-20-ESPCN_reproduction.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/ESPCN_reproduction/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/sfalkena/ESPCN_reproduction/master?filepath=_notebooks%2F2020-04-20-ESPCN_reproduction.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/ESPCN_reproduction/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/sfalkena/ESPCN_reproduction/blob/master/_notebooks/2020-04-20-ESPCN_reproduction.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/ESPCN_reproduction/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-04-20-ESPCN_reproduction.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
<h3 id="Running-the-experiment-on-Google-Colab">Running the experiment on Google Colab<a class="anchor-link" href="#Running-the-experiment-on-Google-Colab"> </a></h3><p>This notebook is running remotely on the Google Colab platform. Therefore, to save and access the trained model, we needed to mount the Google drive. We used the following code snippet to set up a local drive on our computer.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
<span class="kn">from</span> <span class="nn">torch.utils</span> <span class="kn">import</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">PIL.Image</span> <span class="k">as</span> <span class="nn">pil_image</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">random</span> <span class="k">as</span> <span class="nn">rnd</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/content/gdrive&#39;</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span><span class="s1">&#39;/content/gdrive/My Drive/deep_learning_group_7&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Go to this URL in a browser: https://accounts.google.com/o/oauth2/auth?client_id=947318989803-6bn6qk8qdgf4n4g3pfee6491hc0brc4i.apps.googleusercontent.com&amp;redirect_uri=urn%3aietf%3awg%3aoauth%3a2.0%3aoob&amp;response_type=code&amp;scope=email%20https%3a%2f%2fwww.googleapis.com%2fauth%2fdocs.test%20https%3a%2f%2fwww.googleapis.com%2fauth%2fdrive%20https%3a%2f%2fwww.googleapis.com%2fauth%2fdrive.photos.readonly%20https%3a%2f%2fwww.googleapis.com%2fauth%2fpeopleapi.readonly

Enter your authorization code:
··········
Mounted at /content/gdrive
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;interactive_image.html&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
&lt;!DOCTYPE html&gt;
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
* {box-sizing: border-box;}

.img-comp-container {
  position: relative;
  height: 200px; /*should be the same height as the images*/
}

.img-comp-img {
  position: absolute;
  width: auto;
  height: auto;
  overflow:hidden;
}

.img-comp-img img {
  display:block;
  vertical-align:middle;
}

.img-comp-slider {
  position: absolute;
  z-index:9;
  cursor: ew-resize;
  /*set the appearance of the slider:*/
  width: 40px;
  height: 40px;
  background-color: #2196F3;
  opacity: 0.7;
  border-radius: 50%;
}
</style>
<script>
function initComparisons() {
  var x, i;
  /*find all elements with an "overlay" class:*/
  x = document.getElementsByClassName("img-comp-overlay");
  for (i = 0; i < x.length; i++) {
    /*once for each "overlay" element:
    pass the "overlay" element as a parameter when executing the compareImages function:*/
    compareImages(x[i]);
  }
  function compareImages(img) {
    var slider, img, clicked = 0, w, h;
    /*get the width and height of the img element*/
    w = img.offsetWidth;
    h = img.offsetHeight;
    /*set the width of the img element to 50%:*/
    img.style.width = (w / 2) + "px";
    /*create slider:*/
    slider = document.createElement("DIV");
    slider.setAttribute("class", "img-comp-slider");
    /*insert slider*/
    img.parentElement.insertBefore(slider, img);
    /*position the slider in the middle:*/
    slider.style.top = (h / 2) - (slider.offsetHeight / 2) + "px";
    slider.style.left = (w / 2) - (slider.offsetWidth / 2) + "px";
    /*execute a function when the mouse button is pressed:*/
    slider.addEventListener("mousedown", slideReady);
    /*and another function when the mouse button is released:*/
    window.addEventListener("mouseup", slideFinish);
    /*or touched (for touch screens:*/
    slider.addEventListener("touchstart", slideReady);
    /*and released (for touch screens:*/
    window.addEventListener("touchstop", slideFinish);
    function slideReady(e) {
      /*prevent any other actions that may occur when moving over the image:*/
      e.preventDefault();
      /*the slider is now clicked and ready to move:*/
      clicked = 1;
      /*execute a function when the slider is moved:*/
      window.addEventListener("mousemove", slideMove);
      window.addEventListener("touchmove", slideMove);
    }
    function slideFinish() {
      /*the slider is no longer clicked:*/
      clicked = 0;
    }
    function slideMove(e) {
      var pos;
      /*if the slider is no longer clicked, exit this function:*/
      if (clicked == 0) return false;
      /*get the cursor's x position:*/
      pos = getCursorPos(e)
      /*prevent the slider from being positioned outside the image:*/
      if (pos < 0) pos = 0;
      if (pos > w) pos = w;
      /*execute a function that will resize the overlay image according to the cursor:*/
      slide(pos);
    }
    function getCursorPos(e) {
      var a, x = 0;
      e = e || window.event;
      /*get the x positions of the image:*/
      a = img.getBoundingClientRect();
      /*calculate the cursor's x coordinate, relative to the image:*/
      x = e.pageX - a.left;
      /*consider any page scrolling:*/
      x = x - window.pageXOffset;
      return x;
    }
    function slide(x) {
      /*resize the image:*/
      img.style.width = x + "px";
      /*position the slider:*/
      slider.style.left = img.offsetWidth - (slider.offsetWidth / 2) + "px";
    }
  }
}
</script>
</head>
<body>

<h1>Compare Two Images</h1>

<p>Click and slide the blue slider to compare two images:</p>

<div class="img-comp-container">
  <div class="img-comp-img">
    <img src="./espcn_reproduction_img/sr_img_1.png" width="450" height="300" />
  </div>
  <div class="img-comp-img img-comp-overlay">
    <img src="./espcn_reproduction_img/lr_img_1.png" width="450" height="300" />
  </div>
</div>


<script>
/*Execute a function that will execute an image compare function for each element with the img-comp-overlay class:*/
initComparisons();
</script>

</body>
</html>

</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="ESPCN-Architecture">ESPCN Architecture<a class="anchor-link" href="#ESPCN-Architecture"> </a></h1><p>Below, you can find the ESPCN architecture as defined in the paper. Notice that we have used <code>tanh</code> as activation function, as the writers indicated that this leads to better results.</p>
<p>Most important to notice here is that the sub-pixel convolution layer is divided into two layers: one normal convolutional layer (<code>conv3</code>) and a layer which preforms the SR operation (<code>upsample</code>).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1">#scaling factor</span>

<span class="k">class</span> <span class="nc">SuperResConvNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SuperResConvNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">1</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">PixelShuffle</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using GPU&quot;</span><span class="p">)</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="n">ConvNet</span> <span class="o">=</span> <span class="n">SuperResConvNet</span><span class="p">()</span>
<span class="n">ConvNet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Functions">Functions<a class="anchor-link" href="#Functions"> </a></h1>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">slide_subfolders</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/CVPR2016_ESPCN_OurBenchMarkResult/Ours/yang91/T91/&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;/CVPR2016_ESPCN_OurBenchMarkResult/Ours/x3.0/Set5/&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;/CVPR2016_ESPCN_OurBenchMarkResult/Ours/x3.0/Set14/&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;/CVPR2016_ESPCN_OurBenchMarkResult/Ours/x3.0/BSD300/&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;/CVPR2016_ESPCN_OurBenchMarkResult/Ours/x3.0/BSD500/&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;/CVPR2016_ESPCN_OurBenchMarkResult/Ours/x3.0/SuperText136/&#39;</span><span class="p">]</span>

<span class="c1">#width and height of patches</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">17</span>      

<span class="k">class</span> <span class="nc">Slide</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">slide_subfolders</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">slide_subfolders</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">namelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleteLRImage</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patchlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patchlist_get</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">removePng</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="s1">&#39;returns filename without png&#39;</span>
        <span class="n">filename_parts</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">filename_parts</span>

    <span class="k">def</span> <span class="nf">getList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;returns list of filenames&#39;</span> 
        <span class="k">return</span> <span class="p">[</span><span class="n">Slide</span><span class="o">.</span><span class="n">removePng</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.png&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">deleteLRImage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;deletes LR images from list if they are already made (which they are)&#39;</span>
        <span class="n">name_list_2</span> <span class="o">=</span> <span class="n">Slide</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">name_list_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">name_list_2</span> <span class="k">if</span> <span class="s2">&quot;lr&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="p">]</span>
        <span class="n">name_list</span> <span class="o">=</span>  <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">name_list_1</span> <span class="k">if</span> <span class="s2">&quot;lowRes&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">name_list</span>
    
    <span class="k">def</span> <span class="nf">getPatchList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_name</span><span class="p">):</span>
        <span class="s1">&#39;returns patch list of one image&#39;</span>
        <span class="c1">#get filenames and load images</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">img_name</span>
        <span class="n">lr_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;_lr.png&#39;</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

        <span class="c1">#parameters </span>
        <span class="n">stride_lr</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mi">5</span><span class="o">%</span><span class="k">2</span>,3%2,3%2))
        <span class="n">tot_img_d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lr_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">stride_lr</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">lr_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">stride_lr</span><span class="p">)</span>    <span class="c1">#amount of image in height and width respectively</span>
        <span class="n">tot_img</span> <span class="o">=</span> <span class="n">tot_img_d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">tot_img_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>     <span class="c1">#total amount of images</span>

        <span class="c1">#create list for current image</span>
        <span class="n">patch_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tot_img_d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tot_img_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">patch_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">img_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">patch_list</span>
    
    <span class="k">def</span> <span class="nf">patchlist_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#create patch_list</span>
        <span class="n">patch_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namelist</span><span class="p">)):</span>
            <span class="n">patch_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPatchList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namelist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">patch_list</span><span class="p">),</span> <span class="s1">&#39;trainable patches out of&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namelist</span><span class="p">),</span> <span class="s1">&#39;images.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">patch_list</span>
    
    <span class="k">def</span> <span class="nf">createPatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="s1">&#39;returns a patch&#39;</span>
        <span class="n">img_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">patch_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1">#get corresponding images</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">img_name</span>
        <span class="n">hr_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2YCrCb</span><span class="p">)[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># only get Y channel from YCrCb</span>
        <span class="n">lr_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;_lr.png&#39;</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2YCR_CB</span><span class="p">)[:,:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#create hr patch </span>
        <span class="n">stride_hr</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mi">5</span><span class="o">%</span><span class="k">2</span>,3%2,3%2)))*r
        <span class="n">hr_patch</span> <span class="o">=</span> <span class="n">hr_img</span><span class="p">[</span><span class="n">stride_hr</span><span class="o">*</span><span class="n">patch_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">stride_hr</span><span class="o">*</span><span class="n">patch_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">17</span><span class="o">*</span><span class="n">r</span><span class="p">),</span><span class="n">stride_hr</span><span class="o">*</span><span class="n">patch_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]:(</span><span class="n">stride_hr</span><span class="o">*</span><span class="n">patch_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">17</span><span class="o">*</span><span class="n">r</span><span class="p">)]</span>

        <span class="c1">#create lr patch </span>
        <span class="n">stride_lr</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mi">5</span><span class="o">%</span><span class="k">2</span>,3%2,3%2))
        <span class="n">lr_patch</span> <span class="o">=</span> <span class="n">lr_img</span><span class="p">[</span><span class="n">stride_lr</span><span class="o">*</span><span class="n">patch_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">stride_lr</span><span class="o">*</span><span class="n">patch_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">17</span><span class="p">),</span><span class="n">stride_lr</span><span class="o">*</span><span class="n">patch_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]:(</span><span class="n">stride_lr</span><span class="o">*</span><span class="n">patch_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">17</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">lr_patch</span><span class="p">,</span> <span class="n">hr_patch</span>
    
    <span class="k">def</span> <span class="nf">image_operations_testing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_n</span><span class="p">):</span>

        <span class="c1">#get corresponding images</span>
        <span class="n">hr_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">img_n</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2YCrCb</span><span class="p">)[:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lr_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">img_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-lowRes.png&#39;</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2YCrCb</span><span class="p">)[:,:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#difference in shape: lr*3 and hr, due to sub-sampling (few pixels difference)</span>
        <span class="c1">#--&gt; reshape lr</span>
        <span class="n">lr_img</span> <span class="o">=</span> <span class="n">lr_img</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">hr_img</span> <span class="o">=</span> <span class="n">hr_img</span><span class="p">[:</span><span class="n">lr_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">r</span><span class="p">,:</span><span class="n">lr_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">r</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">lr_img</span><span class="p">,</span> <span class="n">hr_img</span>

    <span class="k">def</span> <span class="nf">colored_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_n</span><span class="p">):</span>
      <span class="s1">&#39;creates colored prediction&#39;</span>
      <span class="c1">#get corresponding images</span>
      <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">img_n</span>
      <span class="n">hr_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;YCbCr&#39;</span><span class="p">)</span>
      <span class="n">lr_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-lowRes.png&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;YCbCr&#39;</span><span class="p">)</span>

      <span class="c1">#upsample</span>
      <span class="n">bicubic</span> <span class="o">=</span> <span class="n">lr_img</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">hr_img</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">BICUBIC</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">lr_img</span><span class="p">,</span> <span class="n">bicubic</span><span class="p">,</span> <span class="n">hr_img</span> <span class="c1"># return as pil images</span>

<span class="k">def</span> <span class="nf">getSlideList</span><span class="p">(</span><span class="n">slide_subfolders</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">slides</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">slide</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slide_subfolders</span><span class="p">):</span>
        <span class="n">slides</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Slide</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">slides</span>

<span class="n">slides</span> <span class="o">=</span> <span class="n">getSlideList</span><span class="p">(</span><span class="n">slide_subfolders</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="PSNR-calculation">PSNR calculation<a class="anchor-link" href="#PSNR-calculation"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">psnr_from_mselist</span><span class="p">(</span><span class="n">mse_list</span><span class="p">):</span>
  <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mse_list</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">mse</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">255</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">calc_mse</span><span class="p">(</span><span class="n">img_pred</span><span class="p">,</span> <span class="n">img_hr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">img_pred</span><span class="o">*</span><span class="mi">255</span> <span class="o">-</span> <span class="n">img_hr</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Obtaining-low-resolution-images">Obtaining low resolution images<a class="anchor-link" href="#Obtaining-low-resolution-images"> </a></h1>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># ## DONT RUN THIS CELL, LR IMAGES ARE ALREADY MADE AND PRESENT IN DIRECTORY</span>
<span class="c1"># def createLowRes(img_name, dir_91):</span>
<span class="c1">#   &#39;saves low resolution image&#39;</span>
<span class="c1">#   # Call HR image</span>
<span class="c1">#   filename = dir_91 + img_name + &#39;.png&#39;</span>
<span class="c1">#   hr_img = cv2.cvtColor(cv2.imread(filename), cv2.COLOR_BGR2RGB)</span>

<span class="c1">#   # Blur HR image</span>
<span class="c1">#   blur_img = cv2.GaussianBlur(hr_img,(5,5),0)</span>

<span class="c1">#   # Apply subsampling</span>
<span class="c1">#   lr_img = blur_img[::r,::r]</span>
<span class="c1">#   #print(&#39;Shape HR image: &#39;, hr_img.shape)</span>
<span class="c1">#   #print(&#39;Shape LR image: &#39;, lr_img.shape)</span>

<span class="c1">#   # Save lr_img</span>
<span class="c1">#   im = Image.fromarray(lr_img)</span>
<span class="c1">#   im.save(dir_91 + img_name + &#39;_lr.png&#39;)</span>

<span class="c1"># for i in range(len(slides[0].)):</span>
<span class="c1">#   dir_91 = path + slide_subfolders[0]</span>
<span class="c1">#   createLowRes(slides[0].namelist[i], dir_91)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
<h1 id="Training">Training<a class="anchor-link" href="#Training"> </a></h1><p>-loss \
-optimizer</p>
<p>-stopping criterion (anders gedaan dan in paper) \
-learning rate verhaal \</p>
<p>Eigenlijk zouden we hier nog validation bij moeten doen. Dus ongeveer 80% van patches gebruiken voor training, 20% gebruiken voor validation. Maar dat heb ik nu niet toegevoegd. Zouden we nog kunnen doen na morgenochtend</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Hyperparameter-settings">Hyperparameter settings<a class="anchor-link" href="#Hyperparameter-settings"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">## Loss and optimizer</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>     
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">ConvNet</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>  

<span class="c1">## Stopping criterion</span>
<span class="n">num_epoch</span> <span class="o">=</span> <span class="mi">5000</span>     <span class="c1">#amount of epochs</span>

<span class="c1">## Scheduler for dynamic reduction of the learning rate</span>
<span class="n">threshold_mu</span> <span class="o">=</span> <span class="mf">1e-6</span>     <span class="c1"># Treshold for decreasing learning rate. Default threshold: 0.0001, paper does not say anything about value of threshold.</span>
<span class="n">factor_value</span> <span class="o">=</span> <span class="mf">0.8</span>     <span class="c1"># Amount of decay per step, new lr = factor_value*lr. Default value: 0.1, paper does not say anything about this value.</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="n">factor_value</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold_mu</span><span class="p">,</span> <span class="n">min_lr</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-08</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">## Batch size</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">16</span>

<span class="c1">## training validation ratio</span>
<span class="n">train_val_ratio</span> <span class="o">=</span> <span class="mf">0.95</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
<h3 id="Data-loader">Data loader<a class="anchor-link" href="#Data-loader"> </a></h3><p>-waarom en hoe we data loader/generator hebben gebruikt</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DataGenerator</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="s1">&#39;Generates the dataset that is used for training the ESPCN&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slides</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slides</span> <span class="o">=</span> <span class="n">slides</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()])</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">patchlist</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">lr_patch</span><span class="p">,</span> <span class="n">hr_patch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">createPatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">patchlist</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        
        <span class="c1"># transform images to pytorch tensors</span>
        <span class="n">lr_patch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">lr_patch</span><span class="p">)</span>
        <span class="n">hr_patch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">hr_patch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lr_patch</span><span class="p">,</span> <span class="n">hr_patch</span>   

<span class="c1"># Put DataGenerator in DataLoader</span>
<span class="n">full_dataset</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">slides</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Split between training and validation set</span>
<span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">train_val_ratio</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_dataset</span><span class="p">))</span>
<span class="n">validation_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_dataset</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_size</span>
<span class="n">training_set</span><span class="p">,</span> <span class="n">validation_set</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span><span class="n">full_dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">train_size</span><span class="p">,</span> <span class="n">validation_size</span><span class="p">])</span>

<span class="c1"># num_workers should parallelize loading of the batches by the CPU</span>
<span class="n">training_generator</span>      <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">training_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
<span class="n">validation_generator</span>    <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">validation_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Training-the-model">Training the model<a class="anchor-link" href="#Training-the-model"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Lists used for saving losses and PSNR</span>
<span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">epoch_loss_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">val_loss_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">validation_psnr</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Start stopwatch</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epoch</span><span class="p">):</span>
    <span class="c1"># Switch to training mode</span>
    <span class="n">ConvNet</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">lr_patch</span><span class="p">,</span> <span class="n">hr_patch</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">training_generator</span><span class="p">):</span>
        
        <span class="c1"># Transfer training data to active device</span>
        <span class="n">lr_patch</span><span class="p">,</span> <span class="n">hr_patch</span> <span class="o">=</span> <span class="n">lr_patch</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">hr_patch</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># Run the forward pass</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">ConvNet</span><span class="p">(</span><span class="n">lr_patch</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">hr_patch</span><span class="p">)</span>
        <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

        <span class="c1"># Backprop and perform Adam optimisation</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># Save loss every epoch</span>
    <span class="n">epoch_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_list</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">training_generator</span><span class="p">)</span>
    <span class="n">epoch_loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Epoch&quot;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="s2">&quot;loss: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">))</span>
    
    <span class="c1"># Save model every 1000 epochs</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">999</span><span class="p">:</span>
        <span class="s1">&#39;Save model every 1000 epochs (in case Google Colab stops runtime)&#39;</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;test3_mu_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">threshold_mu</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_epochs&#39;</span>
        <span class="n">path_model</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;/introductory_notebooks/saved_models/&#39;</span> <span class="o">+</span> <span class="n">model_name</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ConvNet</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">path_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model saved as: &#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>

    <span class="c1"># Step to next step of lr-scheduler</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">)</span>
    <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Enter validation mode</span>
    <span class="n">ConvNet</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="c1"># Keep track of mse for every patch, to collectively calculate PSNR per epoch</span>
    <span class="n">epoch_mse</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">lr_patch</span><span class="p">,</span> <span class="n">hr_patch</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">validation_generator</span><span class="p">):</span>
            <span class="c1"># Transfer training data to active device (GPU)</span>
            <span class="n">lr_patch</span><span class="p">,</span> <span class="n">hr_patch</span> <span class="o">=</span> <span class="n">lr_patch</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">hr_patch</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># Predict output</span>
            <span class="n">img_pred</span> <span class="o">=</span> <span class="n">ConvNet</span><span class="p">(</span><span class="n">lr_patch</span><span class="p">)</span>
            
            <span class="c1"># Calculate validation loss</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">img_pred</span><span class="p">,</span> <span class="n">hr_patch</span><span class="p">)</span>
            <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            
            <span class="c1"># Calculate mse for every sample </span>
            <span class="n">img_pred</span> <span class="o">=</span> <span class="n">img_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">hr_patch</span> <span class="o">=</span> <span class="n">hr_patch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">epoch_mse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_mse</span><span class="p">(</span><span class="n">img_pred</span><span class="p">,</span> <span class="n">hr_patch</span><span class="p">))</span>

        <span class="c1"># Calculate validation psnr on the complete epoch from all individual MSE&#39;s</span>
        <span class="n">val_psnr</span> <span class="o">=</span> <span class="n">psnr_from_mselist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">epoch_mse</span><span class="p">))</span>
        <span class="n">validation_psnr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_psnr</span><span class="p">)</span>
    
    <span class="c1"># Save validation loss every epoch</span>
    <span class="n">val_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_list</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">validation_generator</span><span class="p">)</span>
    <span class="n">val_loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
    
    <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training took </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Seconds per epoch:&#39;</span><span class="p">,(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="n">num_epoch</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Plot-training-results">Plot training results<a class="anchor-link" href="#Plot-training-results"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Show training and validation loss of current model in memory</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PSNR for validation data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_epoch</span><span class="p">),</span> <span class="n">validation_psnr</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Loss per epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_epoch</span><span class="p">),</span> <span class="n">epoch_loss_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_epoch</span><span class="p">),</span> <span class="n">val_loss_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Saving-the-model">Saving the model<a class="anchor-link" href="#Saving-the-model"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Save the current model in memory</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/introductory_notebooks/mu/&#39;</span> <span class="o">+</span> <span class="s1">&#39;mu_1e-2&#39;</span>
<span class="n">path_name</span> <span class="o">=</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s1">&#39;_validation_psnr&#39;</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_name</span><span class="p">,</span> <span class="n">validation_psnr</span><span class="p">)</span>
<span class="n">path_name</span> <span class="o">=</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s1">&#39;_epoch_loss_list&#39;</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_name</span><span class="p">,</span> <span class="n">epoch_loss_list</span><span class="p">)</span>
<span class="n">path_name</span> <span class="o">=</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s1">&#39;_val_loss_list&#39;</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_name</span><span class="p">,</span> <span class="n">val_loss_list</span><span class="p">)</span>
<span class="n">path_model</span> <span class="o">=</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s1">&#39;_model&#39;</span>
<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ConvNet</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">path_model</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model saved as: &#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Testing">Testing<a class="anchor-link" href="#Testing"> </a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Loading-the-model">Loading the model<a class="anchor-link" href="#Loading-the-model"> </a></h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;final_test_5000_epochsweights&#39;</span>
<span class="n">path_model</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/introductory_notebooks/combined/&#39;</span> <span class="o">+</span> <span class="n">model_name</span>
<span class="n">ConvNet</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path_model</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-image-functions">Test image functions<a class="anchor-link" href="#Test-image-functions"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">generate_figure</span><span class="p">(</span><span class="n">lr_img</span><span class="p">,</span> <span class="n">sr_img</span><span class="p">,</span> <span class="n">hr_img</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Show the low resolution image, together with the original high resolution image and upscaled version.</span>
<span class="sd">  Is used for a visual representation of how well the model behaves. &quot;&quot;&quot;</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
  <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToPILImage</span><span class="p">(</span><span class="s1">&#39;YCbCr&#39;</span><span class="p">)(</span><span class="n">lr_img</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">))</span>
  <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToPILImage</span><span class="p">(</span><span class="s1">&#39;YCbCr&#39;</span><span class="p">)(</span><span class="n">sr_img</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">))</span>
  <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToPILImage</span><span class="p">(</span><span class="s1">&#39;YCbCr&#39;</span><span class="p">)(</span><span class="n">hr_img</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">))</span>
  

<span class="k">def</span> <span class="nf">save_tensor_as_image</span><span class="p">(</span><span class="n">lr_img</span><span class="p">,</span> <span class="n">sr_img</span><span class="p">,</span> <span class="n">hr_img</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Save the tensors as PIL images in the saved_image folder.&quot;&quot;&quot;</span>
  <span class="n">transforms</span><span class="o">.</span><span class="n">ToPILImage</span><span class="p">(</span><span class="s1">&#39;YCbCr&#39;</span><span class="p">)(</span><span class="n">lr_img</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/introductory_notebooks/saved_images/lr_img_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
  <span class="n">transforms</span><span class="o">.</span><span class="n">ToPILImage</span><span class="p">(</span><span class="s1">&#39;YCbCr&#39;</span><span class="p">)(</span><span class="n">sr_img</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/introductory_notebooks/saved_images/sr_img_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
  <span class="n">transforms</span><span class="o">.</span><span class="n">ToPILImage</span><span class="p">(</span><span class="s1">&#39;YCbCr&#39;</span><span class="p">)(</span><span class="n">hr_img</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/introductory_notebooks/saved_images/hr_img_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Data-loader">Data loader<a class="anchor-link" href="#Data-loader"> </a></h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DataGenerator_test</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
  <span class="s1">&#39;Generates the dataset used for testing&#39;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slides</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slides</span> <span class="o">=</span> <span class="n">slides</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()])</span>

  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">namelist</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">lr_img</span><span class="p">,</span> <span class="n">bicubic</span><span class="p">,</span> <span class="n">hr_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">colored_prediction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">namelist</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    
    <span class="n">lr_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">lr_img</span><span class="p">)</span>
    <span class="n">hr_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">hr_img</span><span class="p">)</span>
    <span class="n">bicubic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">bicubic</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">lr_img</span><span class="p">,</span> <span class="n">bicubic</span><span class="p">,</span> <span class="n">hr_img</span>

<span class="c1">## Put DataGenerator in DataLoader</span>
<span class="k">def</span> <span class="nf">DataGenerator</span><span class="p">(</span><span class="n">slides</span><span class="p">):</span>
  <span class="n">test_set</span> <span class="o">=</span> <span class="n">DataGenerator_test</span><span class="p">(</span><span class="n">slides</span><span class="p">)</span>
  <span class="n">test_generator</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">test_generator</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Testing-the-model">Testing the model<a class="anchor-link" href="#Testing-the-model"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Create predictions</span>
<span class="c1">#0: Yang91.</span>
<span class="c1">#1: Set5</span>
<span class="c1">#2: Set14</span>
<span class="c1">#3: BSD300</span>
<span class="c1">#4: BSD500</span>
<span class="c1">#5: SuperText136</span>
<span class="c1">#To train on all datasets: for j in range(len(slides[1:]))</span>

<span class="n">rnd</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">testsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Set5&#39;</span><span class="p">,</span><span class="s1">&#39;Set14&#39;</span><span class="p">,</span><span class="s1">&#39;BSD300&#39;</span><span class="p">,</span><span class="s1">&#39;BSD500&#39;</span><span class="p">,</span><span class="s1">&#39;SuperText136&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slides</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
  <span class="n">test_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">slides</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
  <span class="n">show</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">test_generator</span><span class="p">))</span>

  <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">mse_list</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="c1">#for epoch in range(1): </span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">lr_img</span><span class="p">,</span> <span class="n">bicubic</span><span class="p">,</span> <span class="n">hr_img</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_generator</span><span class="p">):</span> <span class="c1">#currently in form: [1,3,x,y]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        
      <span class="c1"># Only test on the Y (intensity channel)</span>
      <span class="n">to_network</span> <span class="o">=</span> <span class="p">(</span><span class="n">lr_img</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,:])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

      <span class="c1">#Run the forward pass. Testing is done on CPU now</span>
      <span class="n">outputs</span> <span class="o">=</span> <span class="n">ConvNet</span><span class="o">.</span><span class="n">cpu</span><span class="p">()(</span><span class="n">to_network</span><span class="p">)</span>
      <span class="n">img_pred</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="c1"># substitute the Y channel from bicubic with the one outputted by the model</span>
      <span class="n">bicubic</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">img_pred</span> 
    
      <span class="n">mse</span> <span class="o">=</span> <span class="n">calc_mse</span><span class="p">(</span><span class="n">img_pred</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">hr_img</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:,</span><span class="mi">0</span><span class="p">,:,:])</span>
      <span class="n">mse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

      <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">generate_figure</span><span class="p">(</span><span class="n">lr_img</span><span class="p">,</span> <span class="n">bicubic</span><span class="p">,</span> <span class="n">hr_img</span><span class="p">)</span>
        <span class="n">save_tensor_as_image</span><span class="p">(</span><span class="n">lr_img</span><span class="p">,</span> <span class="n">bicubic</span><span class="p">,</span> <span class="n">hr_img</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

  <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">testsets</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">psnr_from_mselist</span><span class="p">(</span><span class="n">mse_list</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="sfalkena/ESPCN_reproduction"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/ESPCN_reproduction/fastpages/jupyter/2020/04/20/ESPCN_reproduction.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/ESPCN_reproduction/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/ESPCN_reproduction/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/ESPCN_reproduction/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Where I will keep my blogs of projects that I did.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/fastai" title="fastai"><svg class="svg-icon grey"><use xlink:href="/ESPCN_reproduction/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/fastdotai" title="fastdotai"><svg class="svg-icon grey"><use xlink:href="/ESPCN_reproduction/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
